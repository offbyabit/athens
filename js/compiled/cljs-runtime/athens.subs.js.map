{"version":3,"sources":["athens/subs.cljs"],"mappings":"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","names":["G__53588","G__53589","re-frame.core/reg-sub","db","_","G__53590","G__53591","G__53592","G__53593","G__53595","G__53596","re-posh.core/reg-query-sub","G__53597","G__53598","G__53599","G__53600","G__53601","G__53602","re-posh.core/reg-pull-sub","G__53603","G__53604","G__53608","G__53609","G__53611","G__53612","G__53613","G__53614","G__53616","G__53617","G__53618","p__53619","vec__53620","cljs.core.nth.cljs$core$IFn$_invoke$arity$3","id","G__53623","re-posh.core/subscribe","block","athens.blocks/sort-block","G__53628","G__53629","G__53631","G__53632","G__53633","p__53634","vec__53635","G__53638","cljs.core/reverse","cljs.core/rest","b","res","cljs.core.conj.cljs$core$IFn$_invoke$arity$2","cljs.core/first","cljs.core.dissoc.cljs$core$IFn$_invoke$arity$2","G__53641","G__53642","G__53643","G__53644","re-posh.core/reg-sub","day8.re-frame.tracing/is-trace-enabled?","+debux-dbg-opts+","debux.common.util/send-form!","opts__47114__auto__","result__47115__auto__","debux.common.util/send-trace!","e","e53645","nodes","G__53646","G__53647","G__53648","G__53649","debux.common.util/spy-last","e53658","cljs.core.into.cljs$core$IFn$_invoke$arity$2","cljs.core.sort_by.cljs$core$IFn$_invoke$arity$2"],"sourcesContent":["(ns athens.subs\n  (:require\n    [athens.blocks :as blocks]\n    [day8.re-frame.tracing :refer-macros [fn-traced]]\n    [re-frame.core :as re-frame]\n    [re-posh.core :as re-posh :refer [subscribe reg-query-sub reg-pull-sub ;; reg-pull-many-sub\n                                      ]]))\n;; note: not refering reg-sub because re-posh and re-frame have different reg-subs\n\n;; re-frame subscriptions\n(re-frame/reg-sub\n  :user\n  (fn [db _]\n    (:user db)))\n\n\n(re-frame/reg-sub\n  :errors\n  (fn [db _]\n    (:errors db)))\n\n\n(re-frame/reg-sub\n  :loading\n  (fn [db _]\n    (:loading db)))\n\n;; datascript queries\n(reg-query-sub\n  :nodes\n  '[:find [?e ...]\n    :where\n    [?e :node/title ?t]])\n\n\n(reg-query-sub\n  :node/refs\n  '[:find ?id\n    :in $ ?regex\n    :where\n    [?e :block/string ?s]\n    [(re-find ?regex ?s)]\n    [?e :block/uid ?id]])\n\n\n(reg-query-sub\n  :page/sidebar\n  '[:find ?order ?title ?bid\n    :where\n    [?e :page/sidebar ?order]\n    [?e :node/title ?title]\n    [?e :block/uid ?bid]])\n\n;; datascript pulls\n(reg-pull-sub\n  :node\n  '[*])\n\n\n(reg-pull-sub\n  :block/uid\n  '[:block/uid])\n\n\n(reg-pull-sub\n  :block/string\n  '[:block/string])\n\n\n(reg-pull-sub\n  :blocks\n  '[:block/string {:block/children ...}])\n\n\n(reg-pull-sub\n  :block/children\n  '[:block/uid :block/string :block/order :block/open :db/id {:block/children ...}])\n\n\n(re-frame/reg-sub\n  :block/children-sorted\n  (fn [[_ id] _]\n    (subscribe [:block/children id]))\n  (fn [block _]\n    (blocks/sort-block block)))\n\n\n(reg-pull-sub\n  :block/_children\n  '[:block/uid :block/string :node/title {:block/_children ...}])\n\n;; layer 3 subscriptions\n\n(re-frame/reg-sub\n  :block/_children2\n  (fn [[_ id] _]\n    (subscribe [:block/_children id]))\n  (fn [block _]\n; find path from nested block to origin node\n    (reverse\n      (rest\n        (loop [b block\n               res []]\n          (if (:node/title b)\n            (conj res b)\n            (recur (first (:block/_children b))\n                   (conj res (dissoc b :block/_children)))))))))\n\n\n(re-posh/reg-sub\n  :pull-nodes\n  :<- [:nodes]\n  (fn-traced [nodes _]\n             {:type :pull-many\n              :pattern '[*]\n              :ids nodes}))\n\n\n(re-frame/reg-sub\n  :favorites\n  :<- [:page/sidebar]\n  (fn-traced [nodes _]\n             (->> nodes\n                  (into [])\n                  (sort-by first))))\n\n;; (rp/reg-sub\n;;  :node/refs2\n;;  (fn [[_ regex]]\n;;    (subscribe [:node/refs regex]))\n;;  (fn [ids _] ; for all refs, find their parents with reverse lookup\n;;    {:type :pull-many\n;;     :pattern '[:node/title :block/uid :block/string {:block/_children ...}]\n;;     :ids (reduce into [] ids)}))\n\n;; (rf/reg-sub\n;;  :node/refs3\n;;  (fn [[_ regex]]\n;;    (subscribe [:node/refs2 regex]))\n;;  (fn [blocks _]\n;;    ;; flatten paths like in :block/_children2 (except keep node/title)\n;;    ;; then normalize refs through group by :node/title\n;;    (->> blocks\n;;         (map (fn [block]\n;;                (reverse\n;;                 (loop [b block\n;;                        res []]\n;;                   (if (:node/title b)\n;;                     (conj res (dissoc b :block/children))\n;;                     (recur (first (:block/_children b))\n;;                            (conj res (dissoc b :block/_children))))))))\n;;         (group-by #(:node/title (first %)))\n;;         (reduce-kv (fn [m k v]\n;;                      (assoc m k (map rest v))) {} ))\n;;    ))\n"]}